# Проект "CalcAPI" – распределённый вычислитель арифметических выражений ![Go](https://img.shields.io/badge/Go-1.20-blue.svg)

Добро пожаловать в репозиторий **yaLyceumFinal2**!  
Здесь реализован «распределённый калькулятор»:  
- **Оркестратор (сервер)**, который принимает арифметические выражения и «разбивает» их на задачи.  
- **Агент (клиент)**, который забирает у оркестратора задачи и выполняет их (имитируя длительные вычисления).

## :rocket: Основной функционал
1. **Регистрация и логин (JWT)**:
  - POST /api/v1/register {"login","password"} → 200 OK или 409 Conflict.
  - POST /api/v1/login {"login","password"} → {"token":"<jwt>"} или 401 Unauthorized.
2. **POST /api/v1/calculate** – добавление нового арифметического выражения  
   - Тело запроса:
     ```json
     {
       "expression": "2+2*2"
     }
     ```
   - Если всё корректно, сервер возвращает `201` и JSON с `{"id":"<uuid>"}`, где `<uuid>` – уникальный идентификатор выражения.
   - Если выражение содержит невалидные символы, вернётся `422 Unprocessable Entity`.

2. **GET /api/v1/expressions** – получение списка всех выражений  
   - Возвращает JSON вида:
     ```json
     {
       "expressions": [
         {
           "id": "<идентификатор>",
           "status": "<статус>",
           "result": <число или null>
         }
       ]
     }
     ```

3. **GET /api/v1/expressions/:id** – получение конкретного выражения  
   - Если существует – `200 OK` + JSON c `{"expression": {...}}`.
   - Если нет такого выражения – `404`.

4. **GET /internal/task** – получение задачи агентом  
   - Если есть готовая к выполнению задача – `200 OK` и JSON вида:
     ```json
     {
       "task": {
         "id": 1,
         "arg1": <число или строка>,
         "arg2": <число или строка>,
         "operation": <операция>,
         "operation_time": 3000
       }
     }
     ```
   - Если нет задач – `404`.

5. **POST /internal/task** – приём результата от агента  
   - Тело запроса:
     ```json
     {
       "id": 1,
       "result": 2.5
     }
     ```
   - Если всё ок – `200 OK` и `{"status":"ok"}`.  
   - Если нет такой задачи – `404`.  
   - Если поля некорректны (не int / float) – `422`.  

## :globe_with_meridians: Простой веб-интерфейс (фронтенд)

В проекте есть фронтенд-часть, которая позволяет:
- Посмотреть список добавленных выражений (их статусы и результаты).
- Ввести новое выражение в простую форму.
- Нужно обновлять страницу для изменений.

## :gear: Переменные окружения
- **DB_PATH** – путь к SQLite базе. По умолчанию ":memory:" (в памяти). Можно указать "storage.db" для реального файла.
- **JWT_SECRET** – секрет для подписи JWT-токенов (по умолчанию "MY_SUPER_SECRET").
- **TIME_ADDITION_MS** – время выполнения операции сложения (миллисекунды)
- **TIME_SUBTRACTION_MS** – время выполнения вычитания
- **TIME_MULTIPLICATIONS_MS** – время умножения
- **TIME_DIVISIONS_MS** – время деления
- **TIME_FULL_MS** – время вычисления «полного» выражения (при опции `operation=FULL`)
- **COMPUTING_POWER** – количество горутин у агента (для параллельных вычислений)
- **GRPC_ADDR** – если используете gRPC (адрес для сервера, напр. ":50051").

## :wrench: Как запустить оркестратор

1. Убедитесь, что установлен Go (версии 1.20+).  
2. Склонируйте репозиторий:
   ```bash
   git clone https://github.com/TuHeKocmoc/yaLyceumFinal2.git
   ```
3. Перейдите в директорию:
  ```bash
  cd yaLyceumFinal2
  ```
4. Установите зависимости:
   ```bash
   go mod download
   ```
5. Запустите оркестратор (сервер), выполнив:
  ```bash
  DB_PATH=storage.db \
  JWT_SECRET=mysecret \
  go run ./cmd/main.go
  ```
  По умолчанию он слушает порт 8080.

## :computer: Как запустить агента

1. 	В отдельном терминале (или на другой «машине»):
  ```bash
  cd yaLyceumFinal2 
  ```
2. Запустите:
  ```bash
  COMPUTING_POWER=2 GRPC_ADDR=localhost:50051 \
  go run ./cmd/agent/main.go
  ```

## :file_folder: Структура проекта

```
yaLyceumFinal2/
├── cmd/
│   ├── main.go         # Точка входа для оркестратора (HTTP + SQLite + gRPC)
│   └── agent/
│       └── main.go     # Точка входа для агента (получение задач, вычисление)
├── internal/
│   ├── model/          # Структуры (Expression, Task, статусы)
│   ├── repository/     # SQLite-репозиторий (CreateExpression, CreateTaskWithArgs, ...)
│   ├── handler/        # HTTP-хендлеры (регистрация/логин, /api/v1/calculate)
│   ├── calc/           # Модуль вычислений (Calc, CheckInput)
│   └── planner/        # Планировщик (PlanTasksWithNestedParen)
├── proto/              # Если есть .proto для gRPC (calc.proto, ...)
├── web/
│   ├── index.html      # Шаблон главной страницы (фронтенд)
│   ├── expression.html # Шаблон отдельной страницы
│   └── static/
│       └── style.css   # CSS-стили
├── EXAMPLE.md          # Примеры использования API (curl)
├── README.md           # Описание проекта (данный файл)
└── go.mod              # Модуль Go
```

## :white_check_mark: Тесты

**Запустить тесты**:
  ```bash
  go test ./... -v
  ```